<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>What Do You Say? - Conversation Coach</title>
    <link rel="stylesheet" href="coach-styles.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icons/icon-192x192.png" type="image/png">
    <meta name="theme-color" content="#16213e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="WhaddyaSay">
    <script src="pwa-core.js"></script>
    <script src="crypto-manager.js"></script>
    <script src="local-storage.js"></script>
    <script src="ai-engine.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üí¨ What Do You Say?</h1>
            <p>Your personal conversation coach</p>
        </header>

        <main class="coach-interface">
            <!-- Initial Prompt -->
            <section class="prompt-section" id="promptSection">
                <div class="coach-avatar">ü§ù</div>
                <h2>Tell me about the situation</h2>
                <p>What conversation are you preparing for? Who are you talking to and what's the context?</p>
                
                <div class="input-methods">
                    <div class="voice-input">
                        <button id="voiceBtn" class="voice-btn">
                            <span class="mic-icon">üé§</span>
                            <span class="voice-text">Speak your situation</span>
                        </button>
                        <div id="voiceStatus" class="voice-status hidden">
                            <span class="pulse">üî¥</span> Listening...
                        </div>
                    </div>
                    
                    <div class="text-divider">
                        <span>or</span>
                    </div>
                    
                    <div class="text-input">
                        <textarea id="situationInput" placeholder="Type your situation here... 

For example:
‚Ä¢ I need to ask my boss for a raise
‚Ä¢ My partner and I keep arguing about money
‚Ä¢ I want to apologize to my friend but don't know how
‚Ä¢ I need to give difficult feedback to a team member"></textarea>
                        <button id="analyzeBtn" class="analyze-btn">
                            ‚ú® Get Advice
                        </button>
                    </div>
                </div>
            </section>

            <!-- Conversation Analysis -->
            <section class="analysis-section hidden" id="analysisSection">
                <div class="analysis-header">
                    <button id="backBtn" class="back-btn">‚Üê Back</button>
                    <h3>Conversation Strategy</h3>
                </div>
                
                <div class="advice-content" id="adviceContent">
                    <!-- Dynamic content will be inserted here -->
                </div>
                
                <div class="action-buttons">
                    <button id="practiceBtn" class="practice-btn">
                        üé≠ Practice This Conversation
                    </button>
                    <button id="saveAdviceBtn" class="save-btn">
                        üíæ Save This Advice
                    </button>
                    <button id="newSituationBtn" class="new-btn">
                        üÜï New Situation
                    </button>
                </div>
            </section>

            <!-- Practice Mode -->
            <section class="practice-section hidden" id="practiceSection">
                <div class="practice-header">
                    <button id="backToPlanBtn" class="back-btn">‚Üê Back to Plan</button>
                    <h3>Practice Session</h3>
                </div>
                
                <div class="practice-content">
                    <div class="scenario-setup" id="scenarioSetup">
                        <!-- Practice scenario will be set up here -->
                    </div>
                    
                    <div class="practice-controls">
                        <button id="startPracticeBtn" class="start-practice-btn">
                            üé¨ Start Role Play
                        </button>
                    </div>
                </div>
            </section>
        </main>

        <!-- Navigation -->
        <nav class="bottom-nav">
            <button id="coachTab" class="nav-btn active">
                <span>üí¨</span>
                <span>Coach</span>
            </button>
            <button id="memoryTab" class="nav-btn">
                <span>üß†</span>
                <span>Memories</span>
            </button>
            <button id="historyTab" class="nav-btn">
                <span>üìö</span>
                <span>History</span>
            </button>
        </nav>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Analyzing your situation...</p>
        </div>
    </div>

    <script>
        // Simplified authentication check for GitHub Pages
        async function checkAuthentication() {
            try {
                // Check session storage first (set by auth.html)
                const sessionAuth = sessionStorage.getItem('whaddyasay_authenticated');
                if (sessionAuth === 'true') {
                    console.log('‚úÖ Session authenticated');
                    return true;
                }

                // Check if PWA crypto manager is available and authenticated
                if (window.cryptoManager && window.cryptoManager.authenticated) {
                    console.log('‚úÖ PWA crypto manager authenticated');
                    return true;
                }

                // No valid authentication found - redirect to auth
                console.log('‚ùå No authentication found, redirecting to auth.html');
                window.location.href = 'auth.html';
                return false;
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = 'auth.html';
                return false;
            }
        }
        
        // Wait for PWA initialization then check auth
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                checkAuthentication().then(authenticated => {
                    if (authenticated) {
                        // Load the main app script
                        const script = document.createElement('script');
                        script.src = 'coach-script.js';
                        document.head.appendChild(script);
                    }
                });
            }, 1000); // Give PWA time to initialize
        });
    </script>
</body>
</html>